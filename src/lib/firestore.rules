rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    function isSignedIn() { return request.auth != null; }
    function isOwner(userId) { return request.auth != null && request.auth.uid == userId; }
    function isAdmin() { return request.auth != null && exists(/databases/$(database)/documents/admins/$(request.auth.uid)); }

    function getAdminData() {
      return get(/databases/$(database)/documents/admins/$(request.auth.uid)).data;
    }
    function getStudentData() {
      return get(/databases/$(database)/documents/students/$(request.auth.uid)).data;
    }

    // Students
    match /students/{studentId} {
      allow read, write: if isOwner(studentId);
      // allow admins to read students in their department (needed for admin dashboard queries)
      allow read: if isAdmin() && resource.data.department == getAdminData().department;
    }

    // Teachers
    match /teachers/{teacherId} {
      allow read: if isOwner(teacherId);
      allow update, delete: if isOwner(teacherId);
      allow create: if isSignedIn() && isOwner(teacherId);

      // admin can see teachers in their department (queries)
      allow read: if isAdmin() && resource.data.department == getAdminData().department;

      // admin can approve; limit to approval fields
      allow update: if isAdmin()
                    && request.resource.data.diff(resource.data).changedKeys()
                       .hasOnly(['isApproved','approvedBy','approvedAt','isApprovalRequested']);
    }

    // Admins
    match /admins/{adminId} {
      allow read, write: if isOwner(adminId);
    }

    // Classes
    match /classes/{classId} {
      // teachers can create
      allow create: if isSignedIn() && exists(/databases/$(database)/documents/teachers/$(request.auth.uid));

      // teacher owner of the class
      allow read, update, delete: if isSignedIn()
                                  && get(/databases/$(database)/documents/classes/$(classId)).data.teacherId == request.auth.uid;

      // admin read/update/delete in their department (admin dashboard queries)
      allow read: if isAdmin() && resource.data.department == getAdminData().department;
      allow update, delete: if isAdmin() && resource.data.department == getAdminData().department;

      // student can read classes matching their dept/sem when fetching a single class
      allow get: if request.auth != null
                 && resource.data.department == getStudentData().department
                 && resource.data.semester == getStudentData().semester;

      // allow listing for signed-in (queries use where filters)
      allow list: if isSignedIn();

      // Attendance subcollection
      match /attendance/{date}/records/{recordId} {
        // student creates own record if class matches dept/sem
        allow create: if request.auth != null
                      && request.resource.data.studentId == request.auth.uid
                      && get(/databases/$(database)/documents/classes/$(classId)).data.department == getStudentData().department
                      && get(/databases/$(database)/documents/classes/$(classId)).data.semester == getStudentData().semester;

        // read by owner-student, class owner-teacher, or admin in department
        allow read: if (request.auth != null
                        && (resource.data.studentId == request.auth.uid
                            || get(/databases/$(database)/documents/classes/$(classId)).data.teacherId == request.auth.uid
                            || (isAdmin()
                                && get(/databases/$(database)/documents/classes/$(classId)).data.department == getAdminData().department)));
      }
    }

    // collection-group read for a student's own records
    match /{path=**}/records/{recordId} {
      allow read: if request.auth != null && resource.data.studentId == request.auth.uid;
    }
  }
}