rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // --- PROFILE RULES ---
    // Users can only read and write to their own profile document.
    match /students/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
    match /teachers/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
    match /admins/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // --- CLASS & ATTENDANCE RULES ---
    match /classes/{classId} {
      // Any authenticated user can view a class's details.
      allow get: if request.auth != null;
      
      // Teachers can create classes.
      allow create: if request.auth != null;
      
      // Only the assigned teacher can update or delete a class.
      allow update, delete: if request.auth != null && get(/databases/$(database)/documents/classes/$(classId)).data.teacherId == request.auth.uid;

      // Teachers and Students need to list all classes for their dashboards.
      // Admins will use a more specific rule below.
      allow list: if request.auth != null;

      // --- ATTENDANCE SUBCOLLECTION ---
      match /attendance/{date}/records/{studentId} {
        // A student can create their own attendance record.
        allow create: if request.auth != null && request.auth.uid == studentId;
        
        // A student can read their OWN record. The class teacher can read ALL records.
        allow read: if request.auth != null && (request.auth.uid == studentId || get(/databases/$(database)/documents/classes/$(classId)).data.teacherId == request.auth.uid);
        
        // The class teacher can list all attendance records.
        allow list: if request.auth != null && get(/databases/$(database)/documents/classes/$(classId)).data.teacherId == request.auth.uid;
      }
    }
    
    // --- ADMIN-SPECIFIC RULES FOR DEPARTMENTAL LISTS ---
    // These rules allow admins to list documents where the department matches their own.
    
    // Admins can list all classes within their department.
    match /classes/{classId} {
        allow list: if request.auth != null && get(/databases/$(database)/documents/admins/$(request.auth.uid)).data.department == resource.data.department;
    }

    // Admins can list all teachers within their department.
    match /teachers/{teacherId} {
      allow list: if request.auth != null && get(/databases/$(database)/documents/admins/$(request.auth.uid)).data.department == resource.data.department;
    }

    // Admins can list all students within their department.
    match /students/{studentId} {
       allow list: if request.auth != null && get(/databases/$(database)/documents/admins/$(request.auth.uid)).data.department == resource.data.department;
    }
  }
}
