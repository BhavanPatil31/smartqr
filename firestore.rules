rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Allow authenticated users to read their own profiles
    match /students/{userId} {
      allow read, update, create: if request.auth != null && request.auth.uid == userId;
    }
    match /teachers/{userId} {
      allow read, update, create: if request.auth != null && request.auth.uid == userId;
    }
    match /admins/{userId} {
      allow read, update, create: if request.auth != null && request.auth.uid == userId;
    }

    // Rules for classes collection
    match /classes/{classId} {
      // Any authenticated user can read class details
      allow read: if request.auth != null;
      // Only teachers can create or update classes
      allow create, update: if request.auth != null && exists(/databases/$(database)/documents/teachers/$(request.auth.uid));
    }
    
    // Rules for attendance records subcollection
    match /classes/{classId}/attendance/{date}/records/{recordId} {
        // Any authenticated user can read attendance records (needed for stats)
        allow read: if request.auth != null;
        // Only authenticated students can create their own attendance record
        allow create: if request.auth != null && request.auth.uid == recordId && exists(/databases/$(database)/documents/students/$(request.auth.uid));
    }
  }
}
