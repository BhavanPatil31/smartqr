
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to get a user's role and department from their profile document.
    // This reduces duplication and makes rules clearer.
    function getUserData(userId, userType) {
      return get(/databases/$(database)/documents/$(userType)/$(userId)).data;
    }

    // STUDENT: Can read and write their own profile.
    match /students/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // TEACHER: Can read and write their own profile.
    match /teachers/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
    
    // ADMIN: Can read and write their own profile.
    match /admins/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // CLASSES
    match /classes/{classId} {
      // Any authenticated user can view a class document (e.g., for details page).
      allow get: if request.auth != null;
      
      // Teachers can create classes.
      allow create: if request.auth != null && exists(/databases/$(database)/documents/teachers/$(request.auth.uid));

      // Only the assigned teacher can update or delete a class.
      allow update, delete: if request.auth != null && resource.data.teacherId == request.auth.uid;
      
      // Admin: Can list classes for their department
      allow list: if request.auth != null && exists(/databases/$(database)/documents/admins/$(request.auth.uid))
                  && getUserData(request.auth.uid, 'admins').department == resource.data.department;

      // ATTENDANCE SUBCOLLECTION
      match /attendance/{date}/records/{studentId} {
        // Students can create their own attendance record.
        allow create: if request.auth != null && request.auth.uid == studentId;

        // Teachers of the class, the student themselves, or an Admin of the department can read a record.
        allow read: if request.auth != null && (
          get(/databases/$(database)/documents/classes/$(classId)).data.teacherId == request.auth.uid ||
          request.auth.uid == studentId ||
          (exists(/databases/$(database)/documents/admins/$(request.auth.uid)) && getUserData(request.auth.uid, 'admins').department == get(/databases/$(database)/documents/classes/$(classId)).data.department)
        );

        // Teachers of the class or an Admin of the department can list all records for a class on a given day.
        allow list: if request.auth != null && (
          get(/databases/$(database)/documents/classes/$(classId)).data.teacherId == request.auth.uid ||
          (exists(/databases/$(database)/documents/admins/$(request.auth.uid)) && getUserData(request.auth.uid, 'admins').department == get(/databases/$(database)/documents/classes/$(classId)).data.department)
        );
      }
    }
    
    // ADMIN-SPECIFIC LIST QUERIES
    // Admins need separate rules to query the top-level collections for their dashboard.
    
    // Allow Admins to list teachers from their own department.
    match /teachers/{teacherId} {
        allow list: if request.auth != null && exists(/databases/$(database)/documents/admins/$(request.auth.uid))
                    && getUserData(request.auth.uid, 'admins').department == resource.data.department;
    }

    // Allow Admins to list students from their own department.
    match /students/{studentId} {
        allow list: if request.auth != null && exists(/databases/$(database)/documents/admins/$(request.auth.uid))
                    && getUserData(request.auth.uid, 'admins').department == resource.data.department;
    }
  }
}

    