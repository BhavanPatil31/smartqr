rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions
    function isUserAuthenticated() {
      return request.auth != null;
    }
    
    function isStudent() {
      return exists(/databases/$(database)/documents/students/$(request.auth.uid));
    }

    function isTeacher() {
      return exists(/databases/$(database)/documents/teachers/$(request.auth.uid));
    }

    function isAdmin() {
      return exists(/databases/$(database)/documents/admins/$(request.auth.uid));
    }

    // STUDENT DATA
    match /students/{studentId} {
      allow read, write: if isUserAuthenticated() && request.auth.uid == studentId;
    }

    // TEACHER DATA
    match /teachers/{teacherId} {
      allow read, write: if isUserAuthenticated() && request.auth.uid == teacherId;
    }

    // ADMIN DATA
    match /admins/{adminId} {
      allow read, write: if isUserAuthenticated() && request.auth.uid == adminId;
    }

    // CLASS DATA
    match /classes/{classId} {
      // Allow read for authenticated users if they are a student in the class's department/semester, 
      // the assigned teacher, or an admin of the department.
      allow get: if isUserAuthenticated() && (
        (isStudent() && resource.data.department == get(/databases/$(database)/documents/students/$(request.auth.uid)).data.department && resource.data.semester == get(/databases/$(database)/documents/students/$(request.auth.uid)).data.semester) ||
        (isTeacher() && resource.data.teacherId == request.auth.uid) ||
        (isAdmin() && resource.data.department == get(/databases/$(database)/documents/admins/$(request.auth.uid)).data.department)
      );
      
      // Allow listing of classes
      allow list: if isUserAuthenticated();

      // Only teachers can create classes
      allow create: if isUserAuthenticated() && isTeacher();
      
      // Only the assigned teacher can update their class
      allow update: if isUserAuthenticated() && isTeacher() && resource.data.teacherId == request.auth.uid;
      
      // No user should be able to delete a class directly
      allow delete: if false;

      // ATTENDANCE SUBCOLLECTION
      match /attendance/{date}/records/{recordId} {
        // Students can only create their own attendance record
        allow create: if isUserAuthenticated() && isStudent() && request.auth.uid == recordId;
        
        // No one can update an attendance record once created
        allow update, delete: if false;
        
        // The assigned teacher, the student who owns the record, or an admin can read.
        allow get: if isUserAuthenticated() && (
            (isTeacher() && get(/databases/$(database)/documents/classes/$(classId)).data.teacherId == request.auth.uid) ||
            (isStudent() && recordId == request.auth.uid) ||
            (isAdmin() && get(/databases/$(database)/documents/classes/$(classId)).data.department == get(/databases/$(database)/documents/admins/$(request.auth.uid)).data.department)
        );

        // Teachers and Admins can list all records for a class on a given date.
        allow list: if isUserAuthenticated() && (
             (isTeacher() && get(/databases/$(database)/documents/classes/$(classId)).data.teacherId == request.auth.uid) ||
             (isAdmin() && get(/databases/$(database)/documents/classes/$(classId)).data.department == get(/databases/$(database)/documents/admins/$(request.auth.uid)).data.department)
        );
      }
    }
  }
}
