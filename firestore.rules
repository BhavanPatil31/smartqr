rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check if a user is an admin of a certain department
    function isAdminOfDepartment(department) {
      return get(/databases/$(database)/documents/admins/$(request.auth.uid)).data.department == department;
    }
    
    // Helper function to check if a user is the teacher of a class
    function isTeacherOfClass(classId) {
      return get(/databases/$(database)/documents/classes/$(classId)).data.teacherId == request.auth.uid;
    }

    // USER PROFILE RULES
    match /students/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
    match /teachers/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
    match /admins/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // LIST RULES FOR ADMINS (Read-only)
    match /classes/{classId} {
        allow list: if request.auth != null && isAdminOfDepartment(resource.data.department);
    }
     match /teachers/{teacherId} {
        allow list: if request.auth != null && isAdminOfDepartment(resource.data.department);
    }
     match /students/{studentId} {
        allow list: if request.auth != null && isAdminOfDepartment(resource.data.department);
    }
    
    // CLASS RULES
    match /classes/{classId} {
      // Teachers and Admins of the same department can get/read classes.
      allow get: if request.auth != null;
      
      // Only authenticated teachers can create a class.
      allow create: if request.auth != null && request.resource.data.teacherId == request.auth.uid;
      
      // Only the teacher who created the class can update or delete it.
      allow update, delete: if request.auth != null && isTeacherOfClass(classId);

      // ATTENDANCE SUBCOLLECTION RULES
      match /attendance/{date}/records/{recordId} {
        // Students can create their own attendance record.
        allow create: if request.auth != null && request.auth.uid == recordId;

        // An authenticated user can read an attendance record if they are the student, the class teacher, or an admin of the department.
        allow get: if request.auth != null && (request.auth.uid == recordId || isTeacherOfClass(classId) || isAdminOfDepartment(get(/databases/$(database)/documents/classes/$(classId)).data.department));
        
        // A class teacher or an admin of the department can list all attendance records for a class on a given date.
        allow list: if request.auth != null && (isTeacherOfClass(classId) || isAdminOfDepartment(get(/databases/$(database)/documents/classes/$(classId)).data.department));
      }
    }
  }
}
