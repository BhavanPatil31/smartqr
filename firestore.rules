
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions
    function isAdmin(department) {
      return exists(/databases/$(database)/documents/admins/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/admins/$(request.auth.uid)).data.department == department;
    }

    function isTeacher(teacherId) {
      return request.auth.uid == teacherId;
    }

    function isStudentInClass(classDoc) {
      let studentProfile = get(/databases/$(database)/documents/students/$(request.auth.uid)).data;
      return studentProfile.department == classDoc.department && studentProfile.semester == classDoc.semester;
    }
    
    function isStudent() {
      return exists(/databases/$(database)/documents/students/$(request.auth.uid));
    }

    // Rules for 'students' collection
    match /students/{studentId} {
      allow read, write: if request.auth.uid == studentId;
      allow list: if request.auth != null; // Allows admins/teachers to see student lists
    }

    // Rules for 'teachers' collection
    match /teachers/{teacherId} {
      allow read, write: if request.auth.uid == teacherId;
      allow list: if request.auth != null;
    }
    
    // Rules for 'admins' collection
    match /admins/{adminId} {
        allow read, write: if request.auth.uid == adminId;
        allow list: if request.auth != null;
    }

    // Rules for 'classes' collection
    match /classes/{classId} {
      allow create: if exists(/databases/$(database)/documents/teachers/$(request.auth.uid));
      allow read: if request.auth != null; // Broad read for authenticated users
      allow list: if request.auth != null;
      allow update: if isTeacher(resource.data.teacherId) || isAdmin(resource.data.department);

      // Rules for 'attendance' subcollection
      match /attendance/{date}/records/{studentId} {
        allow read: if isTeacher(get(/databases/$(database)/documents/classes/$(classId)).data.teacherId) ||
                       isAdmin(get(/databases/$(database)/documents/classes/$(classId)).data.department) ||
                       request.auth.uid == studentId;
        allow create: if request.auth.uid == studentId && isStudentInClass(get(/databases/$(database)/documents/classes/$(classId)).data);
      }
    }
  }
}
