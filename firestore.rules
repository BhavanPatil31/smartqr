rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    function isTeacher() {
      return exists(/databases/$(database)/documents/teachers/$(request.auth.uid));
    }

    function isAdmin() {
      return exists(/databases/$(database)/documents/admins/$(request.auth.uid));
    }
    
    function isStudent() {
      return exists(/databases/$(database)/documents/students/$(request.auth.uid));
    }
    
    function isOwner(classId) {
      return get(/databases/$(database)/documents/classes/$(classId)).data.teacherId == request.auth.uid;
    }
    
    function isAdminOfDepartment(classId) {
      let adminDepartment = get(/databases/$(database)/documents/admins/$(request.auth.uid)).data.department;
      let classDepartment = get(/databases/$(database)/documents/classes/$(classId)).data.department;
      return adminDepartment == classDepartment;
    }

    match /students/{studentId} {
      allow read, write: if request.auth.uid == studentId;
    }

    match /teachers/{teacherId} {
      allow read, write: if request.auth.uid == teacherId;
    }
    
    match /admins/{adminId} {
      allow read, write: if request.auth.uid == adminId;
    }

    match /classes/{classId} {
      allow read: if isStudent() || isTeacher() || isAdmin();
      allow create: if isTeacher();
      allow update, delete: if isTeacher() && resource.data.teacherId == request.auth.uid;

      // Rules for the attendance sub-collection
      match /attendance/{date} {
        // This match is for the document representing a single day, e.g., '2024-08-15'
        // It allows reads if you are a teacher/admin of the class.
        allow read: if (isTeacher() && isOwner(classId)) || (isAdmin() && isAdminOfDepartment(classId));

        // Rules for the records within a specific day's attendance
        match /records/{recordId} {
          allow create: if isStudent();
          allow read: if (isStudent() && recordId == request.auth.uid) || (isTeacher() && isOwner(classId)) || (isAdmin() && isAdminOfDepartment(classId));
          // Listing records for a specific day
          allow list: if (isTeacher() && isOwner(classId)) || (isAdmin() && isAdminOfDepartment(classId));
        }
      }
    }
    
     match /records/{path=**} {
        allow read: if false; // Deny by default, use specific rules above.
     }
  }
}
