rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions
    function isStudent() {
      return exists(/databases/$(database)/documents/students/$(request.auth.uid));
    }
    function isTeacher() {
      return exists(/databases/$(database)/documents/teachers/$(request.auth.uid));
    }
    function isAdmin() {
      return exists(/databases/$(database)/documents/admins/$(request.auth.uid));
    }
    function isAuthenticated() {
      return request.auth != null;
    }
    function getStudentDepartment() {
      return get(/databases/$(database)/documents/students/$(request.auth.uid)).data.department;
    }
    function getStudentSemester() {
      return get(/databases/$(database)/documents/students/$(request.auth.uid)).data.semester;
    }
    function getAdminDepartment() {
      return get(/databases/$(database)/documents/admins/$(request.auth.uid)).data.department;
    }

    // Students Collection
    match /students/{studentId} {
      allow read, update, delete: if request.auth.uid == studentId || isAdmin();
      allow create: if isAuthenticated();
    }

    // Teachers Collection
    match /teachers/{teacherId} {
      allow read, update, delete: if request.auth.uid == teacherId || isAdmin();
      allow create: if isAuthenticated();
    }
    
    // Admins Collection
    match /admins/{adminId} {
       allow read, update, delete: if request.auth.uid == adminId;
       allow create: if isAuthenticated();
    }

    // Classes Collection
    match /classes/{classId} {
      // Teachers can create classes
      allow create: if isTeacher();
      
      // Teachers of this class can update/delete it
      allow update, delete: if isTeacher() && resource.data.teacherId == request.auth.uid;
      
      // Allow reads if user is authenticated (students, teachers, admins)
      // This is broad for simplicity; can be tightened if needed.
      allow get, list: if isAuthenticated();
      
      // Attendance Subcollection
      match /attendance/{date}/records/{recordId} {
         // Anyone authenticated can view records (for stats calculation)
        allow get, list: if isAuthenticated();
        
        // Only students can create their own record
        allow create: if isStudent() && request.auth.uid == recordId;
        
        // No one can update/delete attendance once marked
        allow update, delete: if false;
      }
    }
  }
}
