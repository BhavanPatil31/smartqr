
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    function getRoleData(role) {
      return get(/databases/$(database)/documents/$(role)/$(request.auth.uid)).data;
    }

    // Profile Rules
    match /students/{studentId} {
      allow read, write: if isAuthenticated() && isOwner(studentId);
    }

    match /teachers/{teacherId} {
      allow read, write: if isAuthenticated() && isOwner(teacherId);
    }
    
    match /admins/{adminId} {
      allow read, write: if isAuthenticated() && isOwner(adminId);
    }

    // Class Rules
    match /classes/{classId} {
      // Teachers can create classes for their own department
      allow create: if isAuthenticated() && request.resource.data.teacherId == request.auth.uid;
      
      // Read access for class documents
      allow read: if isAuthenticated() && 
                    (
                      // Student can read if their department and semester match
                      (getRoleData('students').department == resource.data.department && getRoleData('students').semester == resource.data.semester) ||
                      // Teacher can read if they own the class
                      (resource.data.teacherId == request.auth.uid) ||
                      // Admin can read if their department matches
                      (getRoleData('admins').department == resource.data.department)
                    );

      // Only the teacher who owns the class can update or delete it
      allow update, delete: if isAuthenticated() && resource.data.teacherId == request.auth.uid;

      // Rules for attendance subcollections
      match /attendance/{date} {
        // Teachers of the class and Admins of the department can list date documents
        allow list, get: if isAuthenticated() &&
                          (
                            (get(/databases/$(database)/documents/classes/$(classId)).data.teacherId == request.auth.uid) ||
                            (getRoleData('admins').department == get(/databases/$(database)/documents/classes/$(classId)).data.department)
                          );
        
        // Rules for specific attendance records
        match /records/{recordId} {
          // A student can create their own attendance record
          allow create: if isAuthenticated() && isOwner(recordId);
          
          // Read access for specific records
          allow read, list: if isAuthenticated() &&
                          (
                            // Student can read their own record
                            isOwner(recordId) ||
                            // Teacher of the class can read any record in it
                            (get(/databases/$(database)/documents/classes/$(classId)).data.teacherId == request.auth.uid) ||
                            // Admin of the department can read any record
                            (getRoleData('admins').department == get(/databases/$(database)/documents/classes/$(classId)).data.department)
                          );
        }
      }
    }
  }
}
