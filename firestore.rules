rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions
    function isSignedIn() {
      return request.auth != null;
    }

    function isStudent() {
      return exists(/databases/$(database)/documents/students/$(request.auth.uid));
    }
    
    function isTeacher() {
        return exists(/databases/$(database)/documents/teachers/$(request.auth.uid));
    }

    function isAdmin() {
        return exists(/databases/$(database)/documents/admins/$(request.auth.uid));
    }
    
    // STUDENT data is private
    match /students/{studentId} {
      allow read, update, delete: if isSignedIn() && request.auth.uid == studentId;
      allow create: if isSignedIn();
      allow list: if isSignedIn() && isAdmin(); // Admins can list students
    }

    // TEACHER data is private
    match /teachers/{teacherId} {
       allow read, update, delete: if isSignedIn() && request.auth.uid == teacherId;
       allow create: if isSignedIn();
       allow list: if isSignedIn() && isAdmin(); // Admins can list teachers
    }
    
    // ADMIN data is private
    match /admins/{adminId} {
       allow read, update, delete: if isSignedIn() && request.auth.uid == adminId;
       allow create: if isSignedIn();
    }

    // CLASSES can be listed by any authenticated user, but only modified by teachers
    match /classes/{classId} {
      allow read: if isSignedIn(); // Allow reading/listing of class documents for all signed-in users
      allow create: if isSignedIn() && isTeacher();
      allow update, delete: if isSignedIn() && isTeacher() && resource.data.teacherId == request.auth.uid;

      // ATTENDANCE subcollection
      match /attendance/{date}/records/{recordId} {
        allow read: if isSignedIn(); // Allow teachers/admins to read any record
        // Students can only create/update their own attendance record
        allow create, update: if isSignedIn() && isStudent() && recordId == request.auth.uid;
      }
    }
  }
}
