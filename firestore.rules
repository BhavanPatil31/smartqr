
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
  
    // Helper function to check if a user is an admin for a given department
    function isAdminForDepartment(department) {
      return get(/databases/$(database)/documents/admins/$(request.auth.uid)).data.department == department;
    }

    // Students can read/write their own profile
    match /students/{studentId} {
      allow read, write: if request.auth != null && request.auth.uid == studentId;
    }
    
    // Teachers can read/write their own profile
    match /teachers/{teacherId} {
      allow read, write: if request.auth != null && request.auth.uid == teacherId;
    }

    // Admins can read/write their own profile
    match /admins/{adminId} {
        allow read, write: if request.auth != null && request.auth.uid == adminId;
        // Admins can also read other admins' profiles in their department
        allow read: if request.auth != null && isAdminForDepartment(resource.data.department);
    }
    
    // Rules for classes collection
    match /classes/{classId} {
      // Any authenticated user can read class details
      allow read: if request.auth != null;
      // Only the assigned teacher can create/update/delete a class
      allow create, update, delete: if request.auth != null && request.auth.uid == request.resource.data.teacherId;

      // Nested attendance records
      match /attendance/{date}/records/{recordId} {
        // Students can create their own attendance record
        allow create: if request.auth != null && request.auth.uid == recordId;
        // Teachers of the class and Admins of the department can read attendance records
        allow read: if request.auth != null && 
                       (get(/databases/$(database)/documents/classes/$(classId)).data.teacherId == request.auth.uid ||
                        isAdminForDepartment(get(/databases/$(database)/documents/classes/$(classId)).data.department));
      }
    }
  }
}
