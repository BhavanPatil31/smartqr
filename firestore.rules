
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions
    function isStudent() {
      return exists(/databases/$(database)/documents/students/$(request.auth.uid));
    }

    function isTeacher() {
      return exists(/databases/$(database)/documents/teachers/$(request.auth.uid));
    }

    function isAdmin() {
      return exists(/databases/$(database)/documents/admins/$(request.auth.uid));
    }
    
    function getStudentDepartment() {
        return get(/databases/$(database)/documents/students/$(request.auth.uid)).data.department;
    }

    function getAdminDepartment() {
        return get(/databases/$(database)/documents/admins/$(request.auth.uid)).data.department;
    }

    // Profile Rules
    match /students/{studentId} {
      allow read, write: if request.auth.uid == studentId;
    }

    match /teachers/{teacherId} {
      allow read, write: if request.auth.uid == teacherId;
    }
    
    match /admins/{adminId} {
      allow read, write: if request.auth.uid == adminId;
    }

    // Class Rules
    match /classes/{classId} {
      // Students can read classes that match their department
      allow read: if isStudent() && resource.data.department == getStudentDepartment()
                  || isTeacher() && resource.data.teacherId == request.auth.uid
                  || isAdmin() && resource.data.department == getAdminDepartment();
                  
      // Only teachers can create and update classes
      allow create: if isTeacher() && request.resource.data.teacherId == request.auth.uid;
      allow update: if isTeacher() && resource.data.teacherId == request.auth.uid;
      allow delete: if isTeacher() && resource.data.teacherId == request.auth.uid;
    }
    
    // Attendance Records Rules
    // This needs to be a collection group match to allow students to query all their records
    match /{path=**}/records/{recordId} {
      // Who can read attendance records?
      // 1. The student themselves.
      // 2. The teacher of the class.
      // 3. An admin of the department.
      allow read: if (request.auth.uid == resource.data.studentId) ||
                   (isTeacher() && get(/databases/$(database)/documents/classes/$(resource.data.classId)).data.teacherId == request.auth.uid) ||
                   (isAdmin() && get(/databases/$(database)/documents/classes/$(resource.data.classId)).data.department == getAdminDepartment());

      // Who can write attendance records?
      // 1. A student creating their OWN record.
      allow create: if isStudent() && request.resource.data.studentId == request.auth.uid;
      
      // No one should be able to update/delete attendance records from the client.
      allow update, delete: if false;
    }
  }
}
