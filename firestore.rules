rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to get a user's profile data, which contains their department
    function getUserProfile(collectionName, userId) {
      return get(/databases/$(database)/documents/$(collectionName)/$(userId)).data;
    }

    // Students can read/write their own profile
    match /students/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // Teachers can read/write their own profile
    match /teachers/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
    
    // Admins can read/write their own profile
    match /admins/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    match /classes/{classId} {
      // Students can read class info if it matches their profile department/semester
      allow get: if request.auth != null && 
                    exists(/databases/$(database)/documents/students/$(request.auth.uid)) &&
                    let studentProfile = getUserProfile('students', request.auth.uid) in
                    resource.data.department == studentProfile.department &&
                    resource.data.semester == studentProfile.semester;

      // Teachers can read class info if they are the assigned teacher
      allow get: if request.auth != null && 
                    exists(/databases/$(database)/documents/teachers/$(request.auth.uid)) &&
                    resource.data.teacherId == request.auth.uid;
      
      // Teachers can create classes
      allow create: if request.auth != null && 
                       exists(/databases/$(database)/documents/teachers/$(request.auth.uid)) &&
                       request.resource.data.teacherId == request.auth.uid;
                       
      // Admins can read class info for their department
      allow get: if request.auth != null &&
                    exists(/databases/$(database)/documents/admins/$(request.auth.uid)) &&
                    let adminProfile = getUserProfile('admins', request.auth.uid) in
                    resource.data.department == adminProfile.department;

      // Admins can list all classes in their department
      allow list: if request.auth != null &&
                     exists(/databases/$(database)/documents/admins/$(request.auth.uid)) &&
                     let adminProfile = getUserProfile('admins', request.auth.uid) in
                     request.query.limit <= 100 && request.query.offset == null && // Basic query constraints
                     request.resource.data.department == adminProfile.department;


      match /attendance/{date}/records/{recordId} {
        // Students can create their own attendance record
        allow create: if request.auth != null && request.auth.uid == recordId;

        // Teachers can read attendance for their own classes
        allow list, get: if request.auth != null &&
                       exists(/databases/$(database)/documents/teachers/$(request.auth.uid)) &&
                       get(/databases/$(database)/documents/classes/$(classId)).data.teacherId == request.auth.uid;

        // Admins can read attendance for classes in their department
        allow list, get: if request.auth != null &&
                       exists(/databases/$(database)/documents/admins/$(request.auth.uid)) &&
                       let adminProfile = getUserProfile('admins', request.auth.uid) in
                       get(/databases/$(database)/documents/classes/$(classId)).data.department == adminProfile.department;
      }
    }
  }
}
