rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check if a user is an admin for a given department
    function isAdminForDepartment(department) {
      return get(/databases/$(database)/documents/admins/$(request.auth.uid)).data.department == department;
    }
    
    // STUDENT PROFILE RULES
    // A student can read and write to their own profile.
    match /students/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
    
    // TEACHER PROFILE RULES
    // A teacher can read and write to their own profile.
    match /teachers/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // ADMIN PROFILE RULES
    // An admin can read and write to their own profile.
    match /admins/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // CLASS RULES
    match /classes/{classId} {
      // Allow read access to any authenticated user (students, teachers, admins need this).
      allow get: if request.auth != null;
      
      // Teachers can create classes.
      allow create: if request.auth != null;
      
      // Only the assigned teacher can update or delete their own class.
      allow update, delete: if request.auth != null && resource.data.teacherId == request.auth.uid;
      
      // Rules for LIST operations (queries) on the 'classes' collection
      allow list: if request.auth != null;

      // ATTENDANCE SUBCOLLECTION RULES
      match /attendance/{date}/records/{studentId} {
        // Students can create their own attendance record.
        allow create: if request.auth != null && request.auth.uid == studentId;
        
        // Allow read access to the student who owns it, the teacher of the class,
        // or an admin of the correct department.
        allow read: if request.auth != null && 
          (request.auth.uid == studentId || 
           get(/databases/$(database)/documents/classes/$(classId)).data.teacherId == request.auth.uid ||
           isAdminForDepartment(get(/databases/$(database)/documents/classes/$(classId)).data.department));
        
        // Allow list/query access for the class teacher or a department admin.
        allow list: if request.auth != null &&
          (get(/databases/$(database)/documents/classes/$(classId)).data.teacherId == request.auth.uid ||
           isAdminForDepartment(get(/databases/$(database)/documents/classes/$(classId)).data.department));
      }
    }
  }
}
